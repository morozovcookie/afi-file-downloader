{{ $_ := set . "ProjectName" "afi-file-downloader" }}

{{ $_ := set . "Os" "linux" }}
{{ $_ := set . "Arch" "amd64" }}
{{ $_ := set . "GoVersion" "1.15.3" }}

{{ $_ := set . "CGo" "0" }}
{{ $_ := printf "CGO_ENABLED=%s GOOS=%s GOARCH=%s" .CGo .Os .Arch | set . "GoFlags" }}

{{ $_ := .ProjectName | replace "-" "_" | set . "ArtifactName" }}
{{ $_ := printf "%s-%s-%s-%s" .ArtifactName .Os .Arch .GoVersion | replace "." "_" | set . "ArtifactName" }}

project: {{ .ProjectName }}
configVersion: 1
---
image: {{ .ProjectName }}
from: alpine@sha256:d7342993700f8cd7aba8496c2d0e57be0666e80b4c441925fc6f9361fa81d10e # alpine:3.12 linux/amd64
docker:
  CMD: [{{ .ProjectName }}]
import:
- artifact: {{ .ArtifactName }}
  add: /src/out/afi-file-downloader
  to: /usr/bin/afi-file-downloader
  after: setup
---
artifact: {{ .ArtifactName }}
from: golang@sha256:6bdf3cc6cb0509e860e626a339c19b7e842efb8444960bb72d654e33607c34f5 # golang:1.15.3-alpine linux/amd64
git:
- to: /src
  stageDependencies:
    install:
    - go.mod
    - go.sum
    beforeSetup:
    - '**/*.go'
ansible:
  beforeInstall:
  install:
  - name: Install deps
    command: go mod download
    args:
      chdir: /src
  beforeSetup:
  - name: Build binary
    shell: {{ .GoFlags }} go build -ldflags "-s -w" -o ./out/afi-file-downloader ./cmd/afi-file-downloader/main.go
    args:
      chdir: /src
